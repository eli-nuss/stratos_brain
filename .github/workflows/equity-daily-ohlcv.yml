# Equity Daily OHLCV Ingestion
# ============================
# Fetches daily bars from Alpha Vantage API for all active equity assets.
# Runs Mon-Fri at 21:30 UTC (4:30 PM ET) after US market close.
#
# Note: This job takes ~85 minutes with 5,000+ equities at 60 calls/min.
# GitHub Actions has a 6-hour timeout, so this is well within limits.
#
# Manual trigger: Go to Actions > Equity Daily OHLCV > Run workflow

name: Equity Daily OHLCV

on:
  # Scheduled run: Mon-Fri at 21:30 UTC (4:30 PM ET, after market close)
  schedule:
    - cron: '30 21 * * 1-5'
  
  # Manual trigger with optional date override and limit
  workflow_dispatch:
    inputs:
      target_date:
        description: 'Target date (YYYY-MM-DD), leave empty for today'
        required: false
        type: string
      limit:
        description: 'Limit number of assets (for testing), leave empty for all'
        required: false
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  ingest-equities:
    name: Ingest Equity Daily Bars
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours (should complete in ~85 min)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary aiohttp python-dotenv
      
      - name: Determine target date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.target_date }}" ]; then
            echo "date=${{ github.event.inputs.target_date }}" >> $GITHUB_OUTPUT
          else
            echo "date=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi
      
      - name: Build command arguments
        id: args
        run: |
          ARGS="--date ${{ steps.date.outputs.date }}"
          if [ -n "${{ github.event.inputs.limit }}" ]; then
            ARGS="$ARGS --limit ${{ github.event.inputs.limit }}"
          fi
          echo "args=$ARGS" >> $GITHUB_OUTPUT
      
      - name: Run equity OHLCV ingestion
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          ALPHAVANTAGE_API_KEY: ${{ secrets.ALPHAVANTAGE_API_KEY }}
        run: |
          echo "ğŸš€ Starting equity OHLCV ingestion"
          echo "ğŸ“… Target date: ${{ steps.date.outputs.date }}"
          echo "â±ï¸  This may take ~85 minutes for 5,000+ equities..."
          python -m jobs.equity_daily_ohlcv ${{ steps.args.outputs.args }}
      
      - name: Report success
        if: success()
        run: |
          echo "âœ… Equity OHLCV ingestion completed successfully"
          echo "ğŸ“… Date: ${{ steps.date.outputs.date }}"
      
      - name: Report failure
        if: failure()
        run: |
          echo "âŒ Equity OHLCV ingestion failed"
          echo "ğŸ“… Date: ${{ steps.date.outputs.date }}"
          echo "Check the logs above for details"
