# Crypto Daily OHLCV Ingestion
# ============================
# Fetches daily bars from CoinGecko Pro API for all active crypto assets.
# 
# SCHEDULE: Daily at 00:30 UTC
# This runs 30 minutes after midnight UTC to ensure the previous day's
# close price is available. The script will store data as YESTERDAY's date.
#
# Example: Running at 2026-01-06 00:30 UTC will store data for 2026-01-05
#
# Manual trigger: Go to Actions > Crypto Daily OHLCV > Run workflow

name: Crypto Daily OHLCV

on:
  # Scheduled run: Daily at 00:30 UTC (30 min after midnight)
  schedule:
    - cron: '30 0 * * *'
  
  # Manual trigger with optional date override
  workflow_dispatch:
    inputs:
      target_date:
        description: 'Target date to store as (YYYY-MM-DD), leave empty for yesterday'
        required: false
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  ingest-crypto:
    name: Ingest Crypto Daily Bars
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Should complete in ~10 min, 30 min buffer
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary aiohttp python-dotenv
      
      - name: Determine target date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.target_date }}" ]; then
            echo "date=${{ github.event.inputs.target_date }}" >> $GITHUB_OUTPUT
            echo "Using manual date: ${{ github.event.inputs.target_date }}"
          else
            # Default to yesterday UTC
            YESTERDAY=$(date -u -d "yesterday" +%Y-%m-%d)
            echo "date=$YESTERDAY" >> $GITHUB_OUTPUT
            echo "Using yesterday's date: $YESTERDAY"
          fi
      
      - name: Run crypto OHLCV ingestion
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
        run: |
          echo "ğŸš€ Starting crypto OHLCV ingestion"
          echo "ğŸ“… Storing data for: ${{ steps.date.outputs.date }}"
          echo "ğŸ• Current UTC time: $(date -u)"
          python -m jobs.crypto_daily_ohlcv --date ${{ steps.date.outputs.date }}
      
      - name: Report success
        if: success()
        run: |
          echo "âœ… Crypto OHLCV ingestion completed successfully"
          echo "ğŸ“… Data stored for: ${{ steps.date.outputs.date }}"
      
      - name: Report failure
        if: failure()
        run: |
          echo "âŒ Crypto OHLCV ingestion failed"
          echo "ğŸ“… Target date: ${{ steps.date.outputs.date }}"
          echo "Check the logs above for details"
