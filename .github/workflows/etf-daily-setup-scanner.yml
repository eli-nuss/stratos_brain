# ETF/Index/Commodity Daily Setup Scanner
# ========================================
# Scans ETFs, Indices, and Commodities for trading setups based on technical features.
#
# TRIGGERS:
# - After ETF/Index/Commodity Daily Features completes
# - Manual trigger
#
# OUTPUT: Writes setups to setup_signals table

name: ETF/Index/Commodity Daily Setup Scanner

on:
  # Run after features workflow completes
  workflow_run:
    workflows: ["ETF/Index/Commodity Daily Features"]
    types:
      - completed
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      target_date:
        description: 'Target date (YYYY-MM-DD). Leave empty for latest available.'
        required: false
        type: string
      workers:
        description: 'Number of parallel workers'
        required: false
        default: '8'
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  scan-setups:
    name: Scan ETF/Index/Commodity Setups
    runs-on: ubuntu-latest
    # Only run if the triggering workflow succeeded (or if manually triggered)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary pandas numpy
      
      - name: Run setup scanner
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üîç Starting ETF/Index/Commodity setup scanner"
          if [ -n "${{ github.event.inputs.target_date }}" ]; then
            echo "üìÖ Target date: ${{ github.event.inputs.target_date }}"
            python jobs/etf_daily_setup_scanner.py \
              --date ${{ github.event.inputs.target_date }} \
              --workers ${{ github.event.inputs.workers || '8' }}
          else
            echo "üìÖ Using latest available date"
            python jobs/etf_daily_setup_scanner.py \
              --workers ${{ github.event.inputs.workers || '8' }}
          fi
      
      - name: Report success
        if: success()
        run: |
          echo "‚úÖ ETF/Index/Commodity setup scanner completed successfully"
          echo ""
          echo "11 setups scanned (aligned with crypto/equity scanner):"
          echo ""
          echo "Position Trading (60-252 day holds):"
          echo "  - weinstein_stage2: Weinstein Stage 2 breakout"
          echo "  - donchian_55_breakout: Turtle-style 55-day breakout"
          echo "  - rs_breakout: Relative strength breakout"
          echo "  - trend_pullback_50ma: Pullback to 50MA in uptrend"
          echo "  - adx_holy_grail: ADX Holy Grail pullback"
          echo "  - golden_cross: 50MA crosses above 200MA"
          echo "  - breakout_confirmed: Volume-confirmed breakout"
          echo ""
          echo "Swing Trading (10-20 day holds):"
          echo "  - vcp_squeeze: Volatility Contraction Pattern"
          echo "  - gap_up_momentum: Gap up with volume"
          echo "  - oversold_bounce: RSI oversold bounce"
          echo "  - acceleration_turn: Acceleration turn up"
      
      - name: Report failure
        if: failure()
        run: |
          echo "‚ùå ETF/Index/Commodity setup scanner failed"
          echo "Check the logs above for details"
