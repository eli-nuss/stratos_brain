# Company Chat Feature - System Architecture Design

## Overview

This document outlines the architecture for implementing a Manus/ChatGPT-style LLM chat interface within Stratos Brain. Each chat session is dedicated to a specific company (equity or crypto asset), with one chat per company that persists across sessions.

## User Sketch Analysis

Based on the provided wireframe:
- **Left sidebar**: List of company chats (Apple Chat, Google Chat, etc.)
- **Main area**: Chat conversation with message history
- **Right panel**: Fundamentals data display
- **Bottom**: Message input field

---

## 1. Database Schema

### New Tables (Migration 013)

```
┌─────────────────────────────────────────────────────────────────────┐
│                         company_chats                                │
├─────────────────────────────────────────────────────────────────────┤
│ chat_id (PK)          │ UUID                                        │
│ asset_id (UNIQUE)     │ TEXT (e.g., 'AAPL', 'BTC-USD')             │
│ asset_type            │ TEXT ('equity' | 'crypto')                  │
│ display_name          │ TEXT (e.g., 'Apple Inc.')                   │
│ system_prompt         │ TEXT (custom prompt for this company)       │
│ model                 │ TEXT (default: 'gemini-3-pro-preview')      │
│ tools_config          │ JSONB (code_execution, search, functions)   │
│ context_snapshot      │ JSONB (cached fundamentals, signals)        │
│ sandbox_id            │ TEXT (external sandbox identifier)          │
│ status                │ TEXT ('active' | 'archived')                │
│ last_message_at       │ TIMESTAMPTZ                                 │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 1:N
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         chat_messages                                │
├─────────────────────────────────────────────────────────────────────┤
│ message_id (PK)       │ UUID                                        │
│ chat_id (FK)          │ UUID                                        │
│ sequence_num          │ INTEGER (order within chat)                 │
│ role                  │ TEXT ('user'|'assistant'|'tool'|'system')   │
│ content               │ TEXT                                        │
│ tool_calls            │ JSONB (function call requests)              │
│ executable_code       │ TEXT (code generated by model)              │
│ code_execution_result │ TEXT (output from code)                     │
│ grounding_metadata    │ JSONB (search citations)                    │
│ attachments           │ JSONB (generated files/images)              │
│ tokens_in/out         │ INTEGER                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Entity Relationships

```
company_chats (1) ──────< chat_messages (N)
                  ──────< chat_tool_executions (N)
                  ──────< chat_context_snapshots (N)

chat_messages (1) ──────< chat_tool_executions (N)
```

---

## 2. System Architecture

### High-Level Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              FRONTEND (React)                                │
│  ┌─────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐  │
│  │ Chat List   │  │    Chat Interface       │  │  Fundamentals Panel     │  │
│  │ Sidebar     │  │  - Message history      │  │  - Company data         │  │
│  │             │  │  - Code blocks          │  │  - Signals/Scores       │  │
│  │ • AAPL      │  │  - Search citations     │  │  - AI Reviews           │  │
│  │ • GOOGL     │  │  - Generated images     │  │                         │  │
│  │ • BTC-USD   │  │  - Tool execution UI    │  │                         │  │
│  └─────────────┘  └─────────────────────────┘  └─────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼ REST API / WebSocket
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BACKEND (Supabase Edge Functions)                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      company-chat-api                                │    │
│  │  POST /chats              - Create/get chat for company             │    │
│  │  GET  /chats              - List all company chats                  │    │
│  │  POST /chats/:id/messages - Send message & get response             │    │
│  │  GET  /chats/:id/messages - Get message history                     │    │
│  │  POST /chats/:id/context  - Refresh context snapshot                │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         GEMINI 3 PRO API                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐     │
│  │   Chat      │  │   Code      │  │   Google    │  │   Function      │     │
│  │   Session   │  │   Execution │  │   Search    │  │   Calling       │     │
│  │             │  │   Sandbox   │  │   Grounding │  │   (Custom)      │     │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Tool Configuration

Each company chat has access to three tool types:

1. **Code Execution** (Gemini Native)
   - Python sandbox provided by Gemini API
   - Can generate charts, process data, run calculations
   - Output includes code, results, and generated images

2. **Google Search** (Gemini Native)
   - Real-time web search for current information
   - Returns grounding metadata with citations
   - Useful for news, recent events, market updates

3. **Function Calling** (Custom)
   - Access to Stratos Brain database
   - Custom functions for:
     - `get_fundamentals(asset_id)` - Financial data
     - `get_signals(asset_id, date)` - Active signals
     - `get_scores(asset_id, date)` - Composite scores
     - `get_price_history(asset_id, days)` - OHLCV data
     - `get_ai_reviews(asset_id)` - Previous AI analyses

---

## 3. Backend Implementation

### Edge Function: company-chat-api

```typescript
// supabase/functions/company-chat-api/index.ts

import { createClient } from '@supabase/supabase-js';
import { GoogleGenerativeAI } from '@google/generative-ai';

// Initialize Gemini client with tools
const genai = new GoogleGenerativeAI(Deno.env.get('GEMINI_API_KEY'));

// Tool definitions for function calling
const stratosFunctions = [
  {
    name: "get_fundamentals",
    description: "Get financial fundamentals for a company",
    parameters: {
      type: "object",
      properties: {
        asset_id: { type: "string", description: "Asset identifier" }
      },
      required: ["asset_id"]
    }
  },
  {
    name: "get_signals",
    description: "Get active trading signals for an asset",
    parameters: {
      type: "object", 
      properties: {
        asset_id: { type: "string" },
        as_of_date: { type: "string", description: "Date in YYYY-MM-DD format" }
      },
      required: ["asset_id"]
    }
  },
  // ... more functions
];

// Create chat session with all tools enabled
async function createChatSession(chatConfig) {
  const model = genai.getGenerativeModel({
    model: chatConfig.model || "gemini-3-pro-preview",
    tools: [
      { googleSearch: {} },
      { codeExecution: {} },
      { functionDeclarations: stratosFunctions }
    ]
  });
  
  return model.startChat({
    history: chatConfig.history || [],
    systemInstruction: chatConfig.systemPrompt
  });
}

// Handle function calls
async function executeFunctionCall(functionCall, supabase) {
  const { name, args } = functionCall;
  
  switch (name) {
    case "get_fundamentals":
      return await supabase
        .from('equity_fundamentals')
        .select('*')
        .eq('asset_id', args.asset_id)
        .single();
        
    case "get_signals":
      return await supabase
        .from('dashboard_signals')
        .select('*')
        .eq('asset_id', args.asset_id)
        .eq('as_of_date', args.as_of_date);
        
    // ... handle other functions
  }
}
```

### System Prompt Template

```python
COMPANY_CHAT_SYSTEM_PROMPT = """
You are an AI research analyst assistant for {company_name} ({asset_id}).

## Your Capabilities
1. **Code Execution**: You can write and run Python code to analyze data, create charts, and perform calculations.
2. **Web Search**: You can search the web for current news, market updates, and real-time information.
3. **Database Access**: You can query the Stratos Brain database for:
   - Financial fundamentals (revenue, earnings, margins, etc.)
   - Technical signals and indicators
   - Composite scores and rankings
   - Historical price data
   - Previous AI analyses

## Context
- Asset Type: {asset_type}
- Current Date: {current_date}
- Latest Price: ${latest_price}
- Market Cap: {market_cap}

## Guidelines
- Always cite sources when using web search results
- Show your code when performing calculations
- Use the database functions to get accurate, up-to-date data
- Be specific about timeframes and data sources
- Provide actionable insights, not just data dumps

## Available Data
{context_snapshot}
"""
```

---

## 4. Frontend Implementation

### New Components

```
dashboard/client/src/
├── components/
│   ├── CompanyChatList.tsx      # Left sidebar with chat list
│   ├── CompanyChatInterface.tsx # Main chat area
│   ├── CompanyChatMessage.tsx   # Individual message rendering
│   ├── CodeExecutionBlock.tsx   # Render code + output
│   ├── SearchCitationBlock.tsx  # Render search results
│   ├── FundamentalsPanel.tsx    # Right panel with company data
│   └── ChatToolExecution.tsx    # Show tool execution status
├── hooks/
│   ├── useCompanyChats.ts       # Fetch/manage chat list
│   ├── useCompanyChat.ts        # Single chat operations
│   └── useChatMessages.ts       # Message history
└── pages/
    └── CompanyChat.tsx          # Main chat page
```

### Route Structure

```typescript
// App.tsx additions
<Route path="/chat" component={CompanyChatPage} />
<Route path="/chat/:assetId" component={CompanyChatPage} />
```

### UI Layout (Based on Wireframe)

```
┌──────────────────────────────────────────────────────────────────────────┐
│  Stratos Brain                                              [Settings]   │
├────────────┬─────────────────────────────────────────┬───────────────────┤
│            │                                         │                   │
│  Company   │           Chat Messages                 │   Fundamentals    │
│  Chats     │                                         │                   │
│            │  ┌─────────────────────────────────┐   │   Revenue: $X     │
│  ○ Apple   │  │ User: What's the current...     │   │   EPS: $X.XX      │
│  ● Google  │  └─────────────────────────────────┘   │   P/E: XX.X       │
│  ○ Bitcoin │                                         │                   │
│  ○ Tesla   │  ┌─────────────────────────────────┐   │   Signals:        │
│            │  │ Assistant: Based on my analysis │   │   - Bullish: 3    │
│  [+ New]   │  │ [Code Block]                    │   │   - Bearish: 1    │
│            │  │ [Chart Image]                   │   │                   │
│            │  │ Sources: [1] [2] [3]            │   │   Score: 72/100   │
│            │  └─────────────────────────────────┘   │                   │
│            │                                         │                   │
│            ├─────────────────────────────────────────┤                   │
│            │  [Enter message...]            [Send]   │                   │
└────────────┴─────────────────────────────────────────┴───────────────────┘
```

---

## 5. Message Rendering

### Message Types to Handle

1. **Text Content**
   - Markdown rendering
   - Inline citations [1], [2], etc.

2. **Code Execution**
   ```
   ┌─ Python ──────────────────────────────┐
   │ import pandas as pd                   │
   │ df = pd.DataFrame(data)               │
   │ print(df.describe())                  │
   └───────────────────────────────────────┘
   
   ┌─ Output ──────────────────────────────┐
   │        price    volume                │
   │ mean   150.23   1.2M                  │
   │ std    5.67     0.3M                  │
   └───────────────────────────────────────┘
   ```

3. **Generated Images**
   - Matplotlib charts from code execution
   - Displayed inline in chat

4. **Search Citations**
   ```
   Sources:
   [1] Reuters: "Apple Reports Q4 Earnings..." (reuters.com)
   [2] Bloomberg: "Tech Stocks Rally..." (bloomberg.com)
   ```

5. **Function Call Results**
   - Collapsible sections showing data retrieved
   - "Fetched fundamentals for AAPL..."

---

## 6. API Endpoints

### POST /api/company-chat/chats
Create or retrieve a chat for a company.

```json
Request:
{
  "asset_id": "AAPL",
  "asset_type": "equity",
  "display_name": "Apple Inc."
}

Response:
{
  "chat_id": "uuid",
  "asset_id": "AAPL",
  "created_at": "2026-01-08T...",
  "message_count": 0
}
```

### GET /api/company-chat/chats
List all company chats.

```json
Response:
{
  "chats": [
    {
      "chat_id": "uuid",
      "asset_id": "AAPL",
      "display_name": "Apple Inc.",
      "last_message_at": "2026-01-08T...",
      "message_count": 15
    }
  ]
}
```

### POST /api/company-chat/chats/:chatId/messages
Send a message and get AI response.

```json
Request:
{
  "content": "What are the key support levels for this stock?"
}

Response:
{
  "message_id": "uuid",
  "role": "assistant",
  "content": "Based on my analysis...",
  "executable_code": "import pandas as pd...",
  "code_execution_result": "Support levels: $150, $145, $140",
  "grounding_metadata": {
    "sources": [...]
  },
  "attachments": [
    {"type": "image", "url": "...", "mime_type": "image/png"}
  ]
}
```

### GET /api/company-chat/chats/:chatId/messages
Get message history with pagination.

```json
Response:
{
  "messages": [...],
  "has_more": true,
  "next_cursor": "..."
}
```

---

## 7. Implementation Phases

### Phase 1: Database & Basic API (Week 1)
- [ ] Apply migration 013_company_chats.sql
- [ ] Create company-chat-api edge function
- [ ] Implement basic CRUD for chats and messages
- [ ] Test with simple text-only responses

### Phase 2: Gemini Integration (Week 2)
- [ ] Integrate Gemini 3 Pro API
- [ ] Enable code execution tool
- [ ] Enable Google Search grounding
- [ ] Implement function calling for database access

### Phase 3: Frontend Chat UI (Week 3)
- [ ] Create CompanyChatList sidebar component
- [ ] Create CompanyChatInterface main component
- [ ] Implement message rendering (text, code, images)
- [ ] Add FundamentalsPanel

### Phase 4: Polish & Testing (Week 4)
- [ ] Streaming responses
- [ ] Error handling and retry logic
- [ ] Message persistence and history
- [ ] Performance optimization

---

## 8. Technical Considerations

### Code Execution Sandbox

Gemini's built-in code execution provides:
- Isolated Python environment
- Pre-installed libraries (pandas, numpy, matplotlib, etc.)
- Automatic chart generation
- Safe execution with resource limits

**Note**: This is different from a full sandbox like Manus uses. For more advanced code execution (file I/O, network access, etc.), we would need to integrate an external sandbox service like:
- E2B (e2b.dev)
- Modal
- Replit

### Rate Limits & Costs

- Gemini 3 Pro: Check current pricing
- Google Search grounding: Billed per search query
- Code execution: Included in API call

### Security

- All function calls validated server-side
- Database access restricted to read-only for most functions
- User inputs sanitized before processing
- API keys stored in environment variables

---

## 9. Future Enhancements

1. **Streaming Responses**: Real-time token streaming for better UX
2. **Voice Input**: Speech-to-text for hands-free interaction
3. **Multi-Modal Input**: Upload charts/images for analysis
4. **Collaborative Chats**: Share chats with team members
5. **Custom Functions**: User-defined functions for specific workflows
6. **Chat Templates**: Pre-built conversation starters
7. **Export**: Export chat history as PDF/Markdown
