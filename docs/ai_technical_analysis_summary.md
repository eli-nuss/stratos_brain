# Stratos Brain: AI Technical Analysis System Overview

This document provides a comprehensive overview of the AI-powered technical analysis system at the core of the Stratos Brain platform. It details the architecture, data pipeline, signal generation process, and the AI chat functionalities that collectively automate the identification and evaluation of trading opportunities.

## System Architecture

The AI technical analysis system is a key component of the broader Stratos Brain platform. Its architecture is designed for scalability and robustness, processing large volumes of market data daily to generate actionable insights. The system follows a modern data pipeline architecture, leveraging a combination of scheduled jobs, a message queue, and a containerized Python worker.

| Component | Technology | Role |
|---|---|---|
| **Scheduler** | `pg_cron` | Triggers the daily data pipeline at a scheduled time (00:00 UTC). |
| **Job Queue** | `pgmq` | Manages the queue of assets to be processed by the worker, ensuring orderly execution. |
| **Python Worker** | Docker/GCP | The core processing engine. It consumes jobs from the queue and executes the multi-stage data pipeline, including feature calculation, setup scanning, and AI analysis. |
| **Database** | Supabase (PostgreSQL) | Serves as the central repository for all data, including raw market data (`daily_bars`), calculated features (`daily_features`), identified setups (`setup_signals`), and the final AI analysis (`asset_ai_reviews`). |
| **Frontend** | React/Vite | The user-facing dashboard that presents the data and AI insights generated by the backend pipeline. |
| **API** | Supabase Edge Functions | Provides the interface for the frontend to query data and for the AI Chat agents to access the system's analytical tools. |

The high-level data flow begins with `pg_cron` scheduling a job, which is picked up by the Python worker. The worker then executes a series of scripts to fetch, process, and analyze data, storing the results at each stage in the Supabase database. The frontend and AI chat agents then consume this processed data to provide insights to the user.

## Data Pipeline

The core of the AI technical analysis system is a multi-stage data pipeline that processes market data daily. This pipeline is orchestrated by a series of Python scripts, primarily located in the `/jobs` directory. The pipeline consists of the following key stages:

### Stage 1: Data Ingestion & Feature Calculation

This initial stage is responsible for gathering the raw market data and calculating a comprehensive set of technical indicators. This is handled by the following scripts:

- **`equity_daily_ohlcv.py` & `crypto_daily_ohlcv.py`**: These scripts fetch the daily Open, High, Low, Close, and Volume (OHLCV) data for all tracked equities and cryptocurrencies from external APIs (Alpha Vantage, CoinGecko, and Financial Modeling Prep).
- **`equity_daily_features.py` & `crypto_daily_features.py`**: Once the raw data is ingested, these scripts calculate over 50 technical indicators for each asset. These features include moving averages, RSI, MACD, Bollinger Bands, ATR, and many more. The calculated features are stored in the `daily_features` table.

### Stage 2: Setup Scanning

After the technical features are calculated, the pipeline scans for predefined trading setups. These setups are specific technical patterns that have been backtested and are defined in the `equity_daily_setup_scanner.py` and `crypto_daily_setup_scanner.py` scripts. The system scans for 11 distinct setup types, including:

- `weinstein_stage2`
- `donchian_55_breakout`
- `rs_breakout`
- `trend_pullback_50ma`
- `adx_holy_grail`
- `golden_cross`
- `breakout_confirmed`
- `vcp_squeeze`
- `gap_up_momentum`
- `oversold_bounce`
- `acceleration_turn`

When a setup is identified, it is recorded in the `setup_signals` table with detailed parameters, including entry price, stop-loss, and target price.

### Stage 3: AI Review

The final and most critical stage is the AI review. This is where the system leverages a Large Language Model (LLM), specifically Google's Gemini, to perform a qualitative analysis of the asset's technical posture. This process is handled by the `equity_daily_ai_signals.py` and `crypto_daily_ai_signals.py` scripts.

For each asset, a detailed prompt is constructed that includes:

- The asset's symbol and name.
- The last 60 days of OHLCV data.
- A curated list of key technical features.

The prompt instructs the Gemini model to act as a professional technical analyst and provide a JSON response containing a comprehensive analysis, including:

- **`ai_direction_score`**: A score from -100 to 100 indicating the AI's bullish or bearish conviction.
- **`confidence`**: The AI's confidence in its analysis.
- **`subscores`**: Scores for trend, momentum, volatility, volume, and pattern.
- **`primary_signal`**: A high-level signal (e.g., "strong_buy", "neutral", "sell").
- **`reasoning`**: A brief explanation of the analysis.

The results of the AI review are stored in the `asset_ai_reviews` table, which is then used to populate the dashboard and power the AI chat agents.

## AI Chat System

The Stratos Brain platform includes a sophisticated AI chat system that allows users to interact with the technical analysis data in a conversational manner. The chat system is powered by Supabase Edge Functions and leverages the same underlying data and AI models as the main data pipeline. There are two primary AI chat agents:

- **Company Chat**: This agent operates within the context of a single asset. It has access to the asset's historical data, technical indicators, AI reviews, and can perform deep-dive analysis using a suite of specialized tools.
- **Global Brain Chat**: This agent has a market-wide perspective. It can screen for assets based on a wide range of criteria, analyze market trends, and provide macro-level insights.

### AI Chat Tools

The power of the AI chat system comes from its ability to use a variety of tools to access and analyze data. These tools are defined in the `supabase/functions/_shared/unified_tools.ts` file and are available to both chat agents. The key tools related to technical analysis include:

- **`screen_assets`**: Scans the entire database for assets matching specific fundamental and technical criteria.
- **`get_asset_fundamentals`**: Retrieves detailed financial fundamentals for a company.
- **`get_price_history`**: Fetches historical OHLCV data for an asset.
- **`get_technical_indicators`**: Retrieves the calculated technical indicators for an asset on a specific date.
- **`get_active_signals`**: Fetches the active trading signals for an asset.
- **`get_ai_reviews`**: Retrieves past AI analysis reviews for an asset.

When a user asks a question, the AI chat system selects the appropriate tool and arguments to answer the query. The tool is then executed by the `supabase/functions/_shared/unified_tool_handlers.ts` file, which queries the database and returns the results to the AI agent. The agent then synthesizes the information and presents it to the user in a clear and concise manner.
